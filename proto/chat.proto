syntax = "proto3";

package chat;

option go_package = "github.com/rexlx/squall/proto";

service ChatService {
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
  // 1. Login Endpoint (replaces POST /login)
  rpc Login(LoginRequest) returns (LoginResponse);
  // 2. Room Management (replaces POST /room/:name)
  rpc JoinRoom(JoinRoomRequest) returns (RoomResponse);
  // 3. Chat Stream (replaces POST /message and WS /ws/...)
  // Clients send messages into this stream and receive broadcasts from it.
  rpc Stream(stream ChatMessage) returns (stream ChatMessage);
  
  // Admin tasks (kept from original)
  rpc CreateRoom(RoomRequest) returns (RoomResponse);
  rpc BanUser(AdminRequest) returns (AdminResponse);
  rpc UpdatePassword(UpdatePasswordRequest) returns (UpdatePasswordResponse);
  rpc UpdateUser(UpdateUserRequest) returns (UpdateUserResponse);
}

// --- Message Definitions ---


message UpdatePasswordRequest {
  string email = 1;
  string old_password = 2;
  string new_password = 3;
}

message UpdatePasswordResponse {
  bool success = 1;
  string message = 2;
}

message UpdateUserRequest {
  User user = 1;
}

message UpdateUserResponse {
  bool success = 1;
  string message = 2;
}

message CreateUserRequest {
  string email = 1;
  string password = 2;
  string first_name = 3;
  string role = 4; // "admin" or "user"
}

message CreateUserResponse {
  bool success = 1;
  string user_id = 2;
  string message = 3;
}

message ChatMessage {
  string room_id = 1;
  string user_id = 2;
  string email = 3;
  int64 timestamp = 4;

  enum MessageType {
    TEXT = 0;
    FILE_CONTROL = 1; // Metadata: Offers, Acceptances, etc.
    FILE_CHUNK = 2;   // Raw transient binary data
  }
  MessageType type = 5;

  // Collapse regular text and file metadata into one "Saved" category
  // and keep raw data in a "Transient" category
  oneof payload {
    string message_content = 6; // Regular chat (Base64 ciphertext)
    FileMetadata file_meta = 7; // Accountability Handshake
    bytes data_chunk = 8;       // Transient binary data (Not saved to DB)
  }

  string reply_to = 9;
  
  // Encryption Metadata for TEXT and FILE_CHUNK
  string iv = 10;
  string hot_sauce = 11;
}

message FileMetadata {
  string file_hash = 1;   // SHA-256 for accountability
  string file_name = 2;
  int64 total_size = 3;
  string action = 4;      // "OFFER", "ACCEPT", "REJECT", "COMPLETE"
}

message LoginRequest {
  string email = 1;
  string password = 2;
}

message LoginResponse {
  User user = 1;
  string token = 2;
  string message = 3;
  bool error = 4;
}

message JoinRoomRequest {
  string email = 1;
  string room_name = 2;
}

message RoomRequest {
  string name = 1;
}

message RoomResponse {
  string room_id = 1;
  string name = 2;
  bool success = 3;
  // You might want to return recent messages upon joining
  repeated ChatMessage history = 4;
}

message AdminRequest {
  string user_id = 1;
  string room_id = 2;
}

message AdminResponse {
  bool success = 1;
}

message User {
  string id = 1;
  string email = 2;
  string first_name = 3;
  string last_name = 4;
  repeated string rooms = 5;
  repeated string history = 6;
}